<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>尚美缤纷新人礼包</title>
    <script src="__STATIC__/js/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="__STATIC__/js/rem.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/iconfont.css"/>
    <script src="__PUBLIC__/js/global.js"></script>
    <script src="__STATIC__/js/need/swiper-4.3.3.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="__STATIC__/js/need/swiper-4.3.3.min.css">
    <script src="__STATIC__/js/layer.js"  type="text/javascript" ></script>
    <link rel="shortcut icon" type="image/x-icon" href="{$tpshop_config.shop_info_store_ico|default='/public/static/images/logo/storeico_default.png'}" media="screen"/>
    <link rel="stylesheet" href="__STATIC__/css/beInvited.css">
</head>
<style>
    .headerRank{
        background: url("http://cdn.cfo2o.com/public/upload/other/beInviteBg.png?x-oss-process=style/s750x750") no-repeat;
        background-size: 100%;
    }

</style>
<body>
<div class="headerRank">
    <div class="headerRankCon">
        <div class="fl texLeft">
            <a onclick="goBack()">
                <img src="__STATIC__/images/texLeft.png" alt="返回"></a>
            </a>
        </div>
        <div class="fr texRight">
            <a href="{:U('Mobile/Index/index')}"  class="homeIndex">
                <img src="__STATIC__/images/texRight.png"  alt="">
            </a>
        </div>
    </div>
    <div class="headerPic">
        <img src="{$data['invitUserHeadPic']|default='http://cdn.cfo2o.com/data/avatar/user_head_default01.png'}?x-oss-process=style/s150x150" alt="">
    </div>
    <div class="headerName">
        <span>“{$data['invitUserName']}”送你</span>
    </div>
</div>
<div class="beInviteCom">
    <img src="__STATIC__/images/beInvuteCom.png" alt="">
</div>

<div class="inviteForm">
    <div class="inviteFormBg">
        <input type="tel" placeholder="输入手机号，领取大礼包" maxlength="11" class="invitePhone">
        <input type="tel" placeholder="短信验证码" maxlength="4" class="inviteCode">
        <button class="getCode" id="getCode" onclick="getCode()" >获取验证码</button>
        <div class="inviteReceive" onclick="goReceive()">
            <img src="__STATIC__/images/inviteReceive.png" alt="">
        </div>
        <div class="inviteBom">
            <img class="fl inviteBomFirst" src="__STATIC__/images/cfInvite.png" alt="">
            <if condition="$subscribe eq 1">
                <else />
                <img class="fr inviteBomSed" onclick="showPop(this)" src="__STATIC__/images/flowMe.png" alt="">
            </if>
        </div>
    </div>
</div>
<!--猜你喜欢-->
<!--<div class="SelectedLike">-->
    <!--<img src="__STATIC__/images/youLike.png" alt="">-->
<!--</div>-->
<!--猜你喜欢-->
<div class="guessLike">
    <div class="guessLikeTop">
        <img src="__STATIC__/images/youLike.png" alt="">
    </div>
    <div class="guessList clearFix">
        <foreach name="$data.goods" item="v">
            <a href="{:U('mobile/Goods/goodsInfo',['id'=>$v.goods_id])}">
                <div class="guessItem">
                    <img src="{$v['original_img']}?x-oss-process=style/s340x340" alt="">
                    <p class="guessTitle">{$v['goods_remark']}</p>
                    <p class="guessCom">{$v['goods_name']}</p>
                    <div class="guessDiv"><span class="guessDivSpan fl">会员价￥ <strong>{$v['shop_price']}</strong> </span> <span class="fr guessRight">¥{$v['market_price']}</span></div>
                </div>
            </a>
        </foreach>
    </div>
</div>
<div class="noMore">
    <span>没有更多了</span>
</div>
<!--<div style="height: 1rem;width: 100%;clear: both"></div>-->

<!--领取成功的弹窗-->
<div class="ordinaryPopBg">
    <div class="ordinary ">
        <p class="fristPop">领取成功</p>
        <img src="__STATIC__/images/successGift.png" alt="">
        <p class="moneyP"><span>188</span>优惠券已发放至您的账户</p>
        <div>
            <a href="{:U('mobile/Index/index')}">
                <button class="secPop">使用优惠券</button>
            </a>
            <a href="{:U('mobile/User/coupon')}">
                <button>查看优惠券</button>
            </a>
        </div>
    </div>
</div>
<!--关注 二维码的弹窗-->
<div class="ordinaryCodeBg ordinaryCodeBgOne">
    <div class="ordinary ">
        <p class="fristPop">领取成功</p>
        <p style="margin-top: .2rem;font-size: .26rem">关注“尚美缤纷”公众号</p>
        <p style="margin-top: .1rem;font-size: .26rem">查看并使用优惠券</p>
        <img src="/index.php?m=Home&c=Index&a=qr_code&data={$QRCodeUrl}&head_pic={$head_pic}" alt="" style="margin-top: 0">
        <p class="codeCom" style="margin-top: 0">长按二维码关注公众号</p>
        <div class="closePop" onclick="close_code()"><img src="__STATIC__/images/qx.png" id="closeImg" alt=""></div>
    </div>
</div>
<!--点击关注 关注号 成功二维码-->
<div class="ordinaryCodeBg">
    <div class="ordinary ">
        <p class="fristPop">关注“尚美缤纷”公众号</p>
        <img src="/index.php?m=Home&c=Index&a=qr_code&data={$QRCodeUrl}&head_pic={$head_pic}" alt="">
        <p class="codeCom">长按二维码关注公众号</p>
        <div class="closePop" onclick="close_code_index()"><img src="__STATIC__/images/qx.png" id="closePopImg" alt=""></div>
    </div>
</div>

<!--分享开始-->
<script>
    // http://cdn.cfo2o.com/public/upload/other/logo_share.png
    var ShareImgUrl ="https://{$_SERVER[HTTP_HOST]}__STATIC__/images/shareNoney.png"; //分享图标
    var ShareTitle = "送你￥188元新人大礼包，点击领取>>"; //分享标题
    var ShareDesc = "尚美缤纷-一家有线下沙龙体验活动的化妆品平台"; //分享描述
    var ShareLink = "{$shareUrl}"; //分享描述
</script>
<include file="public/wx_share"/>
<script type="text/javascript" src="__STATIC__/js/sourch_submit.js"></script>
<script type="text/javascript" src="__STATIC__/js/jquery.lazyload.js"></script>
<script>

    function countdown() {
        var time = 60;
        var a;
        // callback();
        //循环定时器
        a =setInterval(function () {
            if(time <=0){
                window.clearInterval(a);
                $('.getCode').html('获取验证码');
                $('#getCode').attr('disabled',false);
            } else {
                time--;
                $('.getCode').html(time +"s");
                $('#getCode').attr('disabled',true)
            }
        },1000)
        function callback() {

        }
    }
    // 获取验证码
    function getCode() {
        var Phone =$('.invitePhone').val();
        if(Phone == ''){
            layer.open({content:'请输入你的号码！',time:3,skin:"msg"});
            return false;
        }else {
            if(!/^1[3456879]\d{9}$/.test(Phone)){
                layer.open({content:'请输入正确的手机号',time:3,skin:"msg"});
            }else{
                // 验证是注册过
                $.ajax({
                    url: '/index.php?m=Mobile&c=User&a=checkPhone',
                    type: 'post',
                    dataType: 'json',
                    data: { send:Phone, scene: 1},
                    success: function (res) {
                        if (res.data == -2) {
                            //已有登录
                            layer.open({content:res.msg,time:3,skin:"msg"});
                        } else if(res.data == -1) {
                            //手机号已注册
                            layer.open({content:res.msg,time:3,skin:"msg"});
                        } else {
                            //未注册
                            $.ajax({
                                url: '/index.php?m=Home&c=Api&a=send_validate_code&t=' + Math.random(),
                                type: 'post',
                                dataType: 'json',
                                data: { send:Phone, scene: 1},
                                success: function (res) {
                                    if (res.status == 1) {
                                        //成功
                                        countdown()
                                        layer.open({content:res.msg,time:3,skin:"msg"});
                                    } else {
                                        //失败
                                        layer.open({content:res.msg,time:3,skin:"msg"});
                                        window.clearInterval(a);
                                    }
                                }
                            })
                        }
                    }
                })

            }
        }
    }
    var subscribe = '{$subscribe}'? '{$subscribe}': 0;
    var invite_code = '{$invite_code}';

    // 点击领取按钮
    function goReceive() {
        var Phone =$('.invitePhone').val();
        var code =$('.inviteCode').val();
        if(Phone == ''){
            layer.open({content:'请输入你的号码！',time:3,skin:"msg"});
            return false
        }
        if(!/^1[3456879]\d{9}$/.test(Phone)){
            layer.open({content:'请输入正确的手机号',time:3,skin:"msg"});
            return false
        }
        if(code == ''){
            layer.open({content:'请输入你的验证码！',time:3,skin:"msg"});
            return false
        }
        if(!/^\d{4}$/.test(code)){
            layer.open({content:'请输入正确的验证码',time:3,skin:"msg"});
            return false
        }

        if(Phone !='' && code != '' && /^1[3456879]\d{9}$/.test(Phone) && /^\d{4}$/.test(code)){

            $('.inviteReceive').css('pointer-events','none');



            var index = layer.open({type:2,time:300,skin:'msg'});
            $.ajax({
                url: '/index.php?m=Mobile&c=User&a=checkPhone',
                type: 'post',
                dataType: 'json',
                data: { send:Phone, scene: 1},
                success: function (res) {
                    if (res.data == 1) {
                        //可以注册
                        $.ajax({
                            url: "/index.php?m=Mobile&c=User&a=reg",
                            type: 'post',
                            dataType: 'json',
                            data: { username:Phone,mobile_code:code, scene: 1,invite_code:invite_code},
                            success: function (data) {
                                if(data.status == 1){
                                    $.ajax({
                                        url: '/index.php?m=Mobile&c=Index&a=getNewUserGiftCounpon',
                                        type: 'post',
                                        dataType: 'json',
                                        success: function (data) {
                                            if (data.code == 200) {
                                                layer.close(index);
                                                //领取成功
                                                if(subscribe == 1){    //是否关注公众号
                                                    $(".ordinaryPopBg").show()
                                                }else{
                                                    $(".ordinaryCodeBgOne").show()
                                                }
                                                $('.inviteReceive').css('pointer-events','auto');
                                            } else {
                                                //领取失败
                                                layer.close(index);
                                                $('.inviteReceive').css('pointer-events','auto');
                                                layer.open({content:data.msg,time:3,skin:"msg"});
                                            }
                                        }
                                    });
                                }
                                else{
                                    layer.close(index);
                                    $('.inviteReceive').css('pointer-events','auto');
                                    layer.open({content:data.msg,time:3,skin:"msg"});
                                }
                            }
                        })
                    }else if(res.data == -1) {
                        //已注册
                        layer.close(index);
                        $('.inviteReceive').css('pointer-events','auto');
                        layer.open({content:res.msg,time:3,skin:"msg"});
                    }else{
                        //已you登录
                        layer.close(index);
                        $('.inviteReceive').css('pointer-events','auto');
                        layer.open({content:res.msg,time:3,skin:"msg"});
                    }
                }
            })
        }
    }

    function goBack(){
        var his = document.referrer;
        if(his) {
            history.back(-1)
        }else {
            window.location.href = "{:U('Mobile/Index/index')}";
        }
    }
    function showPop() {
        $('.ordinaryCodeBg').show()
    }
    function close_code() {
        // $('.ordinaryCodeBg').hide()
        window.location.href = "{:U('Mobile/Index/index')}";
    }
    function close_code_index() {
        $('.ordinaryCodeBg').hide()
    }

    //滚动事件 / 滑动搜索的效果
    // $(function(){
    //     var $body = $('body');
    //     var setCoverOpacity = function() {
    //         $('.bgCover').css({
    //             opacity: ((($(document).scrollTop() / $('.banner').height()) > 1) ? 1 : ($(document).scrollTop() / $('.banner').height()))
    //         });
    //     };
    //     //初始化设置背景透明度
    //     // setCoverOpacity();
    //     //监听滚动条事件，改变透明度
    //     $(window).scroll(function() {
    //         setCoverOpacity();
    //     });
    // });
    /**
     * ajax加载更多数据
     */
    var ajax_pending = false;//进行中
    var has_more_data = true;//还有数据
    var  page = 1;
    function ajax_sourch_submit() {
        console.log(1);
        if (ajax_pending || has_more_data == false) return;
        ajax_pending = true;
        ++page;
        $.ajax({
            type : "GET",
            url:"/index.php?m=Mobile&c=User&a=beInvited&p="+page,
            success: function(data) {
                ajax_pending = false;
                if ($.trim(data) != '') {
                    console.log(2);
                    $('.guessList').append(data);
                    //加载更多时 懒加载配置
                    $("img.lazy").lazyload({effect: "fadeIn"});
                    $("img.lazy").lazyload({ threshold :180});
                } else {
                    has_more_data = false;
                    $('.noMore').show()
                }
            }
        });
    }


    // 出现滚动条时 固定页面HEADER
    $(function() {
        if ($(window).scrollTop() >=130) {
            $('.headerRankCon ').addClass('fixedHaeder');
        }
        $(window).scroll(function() {
            if ($(window).scrollTop() < 130) {
                $('.headerRankCon ').removeClass('fixedHaeder');
            } else {
                $('.headerRankCon ').addClass('fixedHaeder');
            }
        });

    });
    // 懒加载  相关配置
    $(function() {
        $("img.lazy").lazyload({effect: "fadeIn"});
    });
    $("img.lazy").lazyload({ threshold :180});
    $("img.lazy").lazyload({
        placeholder : "/template/mobile/newbow/static/images/aa.png", //用图片提前占位
        // placeholder,值为某一图片路径.此图片用来占据将要加载的图片的位置,待图片加载时,占位图则会隐藏
        effect: "slideDown", // 载入使用何种效果
        // effect(特效),值有show(直接显示),fadeIn(淡入),slideDown(下拉)等,常用fadeIn
        threshold: 150, // 提前开始加载
        // threshold,值为数字,代表页面高度.如设置为200,表示滚动条在离目标位置还有200的高度时就开始加载图片,可以做到不让用户察觉
        event: 'click',  // 事件触发时才加载
        // event,值有click(点击),mouseover(鼠标划过),sporty(运动的),foobar(…).可以实现鼠标莫过或点击图片才开始加载,后两个值未测试…
        container: $(".guessItem"),  // 对某容器中的图片实现效果
        // container,值为某容器.lazyload默认在拉动浏览器滚动条时生效,这个参数可以让你在拉动某DIV的滚动条时依次加载其中的图片
        failurelimit : 10 // 图片排序混乱时
        // failurelimit,值为数字.lazyload默认在找到第一张不在可见区域里的图片时则不再继续加载,但当HTML容器混乱的时候可能出现可见区域内图片并没加载出来的情况,failurelimit意在加载N张可见区域外的图片,以避免出现这个问题.
    });

</script>
</body>
</html>