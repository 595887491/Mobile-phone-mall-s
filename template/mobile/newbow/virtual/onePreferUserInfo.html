<!DOCTYPE>
<html>
<head>
    <title>完善资料</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <script src="__STATIC__/js/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="__STATIC__/js/jjs.js" type="text/javascript" charset="utf-8"></script>
    <script src="__PUBLIC__/js/global.js"></script>
    <script src="__STATIC__/js/layer.js"  type="text/javascript" ></script>
    <!--时间插件-->
    <script src="__STATIC__/ICalendar/mobileSelect.js"></script>
    <link rel="stylesheet" href="__STATIC__/ICalendar/mobileSelect.css">
    <link rel="stylesheet" href="__STATIC__/ICalendar/public.css">
    <!--<link rel="shortcut icon" type="image/x-icon" href="{$tpshop_config.shop_info_store_ico|default='/public/static/images/logo/storeico_default.png'}" media="screen"/>-->
    <link rel="stylesheet" href="__STATIC__/css/new/team_base.css">
    <link rel="stylesheet" href="__STATIC__/css/new/perfectInfo.css">
</head>

<body style="background: #fff;">
<!--header-->
<div class="headerRank">
    <a href="javascript:history.back()" class="back">
        <img src="__STATIC__/images/return.png" alt="返回"></a>
    </a>
    <div class="txt">
        完善资料
    </div>
    <if condition="$user_num eq 1">
        <a href="javascript:;" class="myTeam" style="" onclick="open_isSkip(event)">
            跳过
        </a>
    </if>

</div>
<div style="height: .88rem;background-color: #F1F5F8;"></div>
<!--header-->
<!--<div id="trigger2">双项选择</div>-->
<div class="content">
    <div class="top" style="color: #D50D16;">
        为了保证顺利完成体检，请如实填写以下信息
    </div>
    <form action="" id="info">
    <div class="user-msg">
       <!--<div class="user-msg-list">-->
           <!--<span>姓<span style="padding-left: 2em;">名</span>：</span>-->
           <!--<input type="text" placeholder="请输入体检人的姓名">-->
       <!--</div>-->

        <!--<div class="user-msg-list">-->
            <!--<span>性<span style="padding-left: 2em;">别</span>：</span>-->
            <!--<select name="" id="">-->
                <!--<option value="">请选择</option>-->
                <!--<option value="">男</option>-->
                <!--<option value="">女</option>-->
            <!--</select>-->
        <!--</div>-->

        <!--<div class="user-msg-list">-->
            <!--<span>手<span style="padding: 0 .13rem;">机</span>号：</span>-->
            <!--<input type="text" placeholder="请输入体检人的手机号">-->
        <!--</div>-->

        <!--<div class="user-msg-list">-->
            <!--<span>身份证号：</span>-->
            <!--<input type="text" placeholder="请输入体检人的身份证号">-->
        <!--</div>-->

        <!--<p style="margin: .65rem 0.25rem .2rem;color: #1E1B1B;">选择您期望的体检分院和体检日期</p>-->

        <!--<div class="user-msg-list">-->
            <!--<span>体检分院：</span>-->
            <!--<select name="" id="">-->
                <!--<option value="">请选择</option>-->
                <!--<option value="">1</option>-->
                <!--<option value="">2</option>-->
            <!--</select>-->
        <!--</div>-->

        <!--<div class="user-msg-list">-->
            <!--<span>体检时间：</span>-->
            <!--<input id="demo1" type="text" readonly="" name="input_date" placeholder="日期选择特效" data-lcalendar="2018-07-26,2019-12-31" />-->
        <!--</div>-->
    </div>
    </form>
    <if condition="$user_num eq 1">
        <a href="javascript:;" class="add-btn" onclick="open_isSave(event)">保存</a>
        <else/>
        <a href="javascript:;" class="add-btn" onclick="open_isSave1(event)">保存</a>
    </if>

    <div class="explain">
        <p>添加完成后，您的专属体检顾问会电话联系您确认信息，最终的体检分院与日期以您与顾问确认的信息为准</p>
        <p style="margin-top: .07rem;">若需要修改信息或调整体检分院和日期，可与您的专属顾问直接沟通，电话：<a href="tel:{$mobile}" style="color: #1E1B1B;">{$mobile}</a></p>
    </div>
</div>
<!--跳过弹窗-->
<div class="popup isSkip">
    <div class="popup-wrap">
        <p>确认跳过？</p>
        <p>跳过后你可在卡券订单详情页面
            完善体检信息</p>
        <div class="btn-wrap">
            <a href="javascript:;" class="fl" onclick="close_popup(event)">继续填写</a>
            <a href="javascript:;" class="fr" style="color: #fff;background-color: #FF407E;">跳过</a>
        </div>
    </div>
</div>

<!--确认保存弹窗-->
<div class="popup isSave" style="">
    <div class="popup-wrap">
        <p>确认保存？</p>
        <p>确认信息无误后点击保存，保存后若需修改信息，请联系专属体检顾问</p>
        <div class="btn-wrap">
            <a href="javascript:;" class="fl" onclick="close_popup(event)">取消</a>
            <a href="javascript:;" class="fr" style="color: #fff;background-color: #FF407E;">保存</a>
        </div>
    </div>
</div>

<!--<div class="popup isOver" style="">-->
    <!--<div class="popup-wrap">-->
        <!--<p>提示！</p>-->
        <!--<p style="width: 80%;">你已经完善过个人信息，已无需再填</p>-->
        <!--<div class="btn-wrap" style="text-align: center;">-->
            <!--&lt;!&ndash;<a href="javascript:;" class="fl" onclick="close_popup(event)">取消</a>&ndash;&gt;-->
            <!--<a href="/Mobile/User/getVirtualOrderInfo.html?order_id={$order_id}" class="" style="color: #fff;background-color: #FF407E;display: inline-block;">返回订单详情</a>-->
        <!--</div>-->
    <!--</div>-->
<!--</div>-->
</body>
<!--<script src="__STATIC__/ICalendar/lCalendar.min.js"></script>-->
<!--<link rel="stylesheet" href="__STATIC__/ICalendar/lCalendar.css">-->
<script>
        // 获取数据病渲染
        var data = {$form_data[0]['dynamic_column']};
        var htmls ='';
        for(var i = 0;i<data.length;i++) {
            switch (data[i].type) {
                case 1:
                    data[i].type = "<input type=\"text\" name="+data[i].name_en+" placeholder="+data[i].desc+">";
                    break;
                case 5:
                    var h ='';
                    for(var k =0;k<data[i].value.length;k++) {
                        h+= "<option value="+data[i].value[k]+">"+data[i].value[k]+"</option>"
                    }
                    data[i].type = " <select name="+data[i].name_en+" id=\"\">" +
                        h +
                        "               </select>" +
                        "            </div>";
                    break;
                case 0:
                    data[i].type = "";
                    break;
                case 3:
                    // data[i].type = " <input id=\"demo1\" type=\"text\" readonly=\"\" name=\"input_date\" placeholder=\"请选择\" data-lcalendar=\"2018-07-30,2018-09-30\" />";
                    data[i].type = "<div id=\"trigger4\">请选择体检时间</div>";
                    break;
            }

            htmls += "<div class=\"user-msg-list\"><i class='select-logo iconfont'>&#xe60c;</i>" +
                "           <span>"+data[i].name+"</span>\n" +"<i>：</i>"+
                data[i].type +
                " </div>"
        }
        $('.user-msg').html(htmls);

        var isOver = {$no_complete_num};

        <if condition='!$no_complete_num'>
               <php> header('Location:'.U('Mobile/User/getVirtualOrdeList'));</php>
        </if>
    // 关闭弹窗
    function close_popup(event) {
      event.stopPropagation();
      $(event.target).closest('.popup').hide();
    }
    //点击跳过
    function open_isSkip(event) {
       $('.isSkip').show();
       $('.btn-wrap .fr').on('click',function () {
           event.stopPropagation();
           window.location.href="/Mobile/User/getVirtualOrderInfo.html?order_id={$order_id}";
       })
    }
    //验证身份证
    function IDCardCheck(num) {
            num = num.toUpperCase();
            //身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X。
            if (!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(num))) {
                return false;
            }
            //校验位按照ISO 7064:1983.MOD 11-2的规定生成，X可以认为是数字10。
            //下面分别分析出生日期和校验位
            var len, re;
            len = num.length;
            if (len == 15) {
                re = new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);
                var arrSplit = num.match(re);

                //检查生日日期是否正确
                var dtmBirth = new Date('19' + arrSplit[2] + '/' + arrSplit[3] + '/' + arrSplit[4]);
                var bGoodDay;
                bGoodDay = (dtmBirth.getYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
                if (!bGoodDay) {

                    return false;
                }
                else {
                    //将15位身份证转成18位
                    //校验位按照ISO 7064:1983.MOD 11-2的规定生成，X可以认为是数字10。
                    var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
                    var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
                    var nTemp = 0, i;
                    num = num.substr(0, 6) + '19' + num.substr(6, num.length - 6);
                    for (i = 0; i < 17; i++) {
                        nTemp += num.substr(i, 1) * arrInt[i];
                    }
                    num += arrCh[nTemp % 11];
                    return true;
                }
            }
            if (len == 18) {
                re = new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);
                var arrSplit = num.match(re);

                //检查生日日期是否正确
                var dtmBirth = new Date(arrSplit[2] + "/" + arrSplit[3] + "/" + arrSplit[4]);
                var bGoodDay;
                bGoodDay = (dtmBirth.getFullYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
                if (!bGoodDay) {

                    return false;
                }
                else {
                    //检验18位身份证的校验码是否正确。
                    //校验位按照ISO 7064:1983.MOD 11-2的规定生成，X可以认为是数字10。
                    var valnum;
                    var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
                    var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
                    var nTemp = 0, i;
                    for (i = 0; i < 17; i++) {
                        nTemp += num.substr(i, 1) * arrInt[i];
                    }
                    valnum = arrCh[nTemp % 11];
                    if (valnum != num.substr(17, 1)) {

                        return false;
                    }
                    return true;
                }
            }
            return false;
        }
    //点击保存 验证表单
    function open_isSave(event) {
        console.log($('#info').serialize())
       var len= $('#info').find("input[type='text']");
       var name = $("input[name='full_name']").val(),
           sex  = $("select[name='sex']").val(),
           mobile =  $("input[name='mobile']").val(),
           id_no  = $("input[name='id_no']").val(),
           hostpital  = $("select[name='hostpital']").val(),
           hostpital  = $("select[name='hostpital']").val(),
           time = $("#trigger4").text();
            // for(i=0;i<len.length;i++) {
            //     if(!$(len[i]).val()) {
            //         layer.open({content:'所有选项为必填项，不能为空',time:2,skin:"msg"})
            //     }
            // }
            if(!name){
                layer.open({content:"请输入姓名",time:2,skin:"msg"})
                return false
            }
            if(!/^1[3|4|5|6|7|8|9][0-9]{9}$/.test(mobile)) {
                layer.open({content:'请输入正确的手机号码！',time:2,skin:"msg"})
                return false
            }
            if(!IDCardCheck(id_no)) {
                layer.open({content:'请输入正确的身份证号码！',time:2,skin:"msg"})
                return false
            }
            if(time =='请选择体检时间'){
                layer.open({content:'请选择体检时间',time:2,skin:"msg"})
                return false
            }
            else {
                $('.isSave').show();
                $('.btn-wrap .fr').on('click',function () {
                    event.stopPropagation();
                    $.ajax({
                        type:'POST',
                        url:'/Mobile/Virtual/saveFormInfo',
                        dataType:'json',
                        data: $('#info').serialize()+"&input_date="+time+"&order_id={$order_id}&form_id={$form_data[0][form_id]}&show_order={$show_order}",
                        // {order_id:'{$order_id}', form_id:'{$form_data[0][form_id]}', name:''},
                        success:function (res) {
                            if(res.status == 1) {
                                window.location.href="/Mobile/User/getVirtualOrderInfo.html?order_id={$order_id}";
                            }else {
                                layer.open({content:res.msg,time:2,skin:'msg'})
                            }
                        }
                    })
                })
            }
    }

    function open_isSave1(event) {
            var len= $('#info').find("input[type='text']");
            var name = $("input[name='full_name']").val(),
                sex  = $("select[name='sex']").val(),
                mobile =  $("input[name='mobile']").val(),
                id_no  = $("input[name='id_no']").val(),
                hostpital  = $("select[name='hostpital']").val(),
                hostpital  = $("select[name='hostpital']").val(),
                time = $("#trigger4").text();
            // for(i=0;i<len.length;i++) {
            //     if(!$(len[i]).val()) {
            //         layer.open({content:'所有选项为必填项，不能为空',time:2,skin:"msg"})
            //     }
            // }
            if(!name){
                layer.open({content:"请输入姓名",time:2,skin:"msg"})
                return false
            }
            if(!/^1[3|4|5|6|7|8|9][0-9]{9}$/.test(mobile)) {
                layer.open({content:'请输入正确的手机号码！',time:2,skin:"msg"})
                return false
            }
            // if(!/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|[x,X])$/.test(id_no)) {
            if(!IDCardCheck(id_no)) {
                layer.open({content:'请输入正确的身份证号码！',time:2,skin:"msg"})
                return false
            }
            if(time =='请选择体检时间'){
                layer.open({content:'请选择体检时间',time:2,skin:"msg"})
                return false
            }
            else {
                $('.isSave').show();
                $('.btn-wrap .fr').on('click',function () {
                    event.stopPropagation();
                    $.ajax({
                        type:'POST',
                        url:'/Mobile/Virtual/saveFormInfo',
                        dataType:'json',
                        data: $('#info').serialize()+"&input_date="+time+"&order_id={$order_id}&form_id={$form_data[0][form_id]}&show_order={$show_order}",
                        // {order_id:'{$order_id}', form_id:'{$form_data[0][form_id]}', name:''},
                        success:function (res) {
                            history.go(-1)
                        }
                    })
                })
            }
        }
    // var calendar = new lCalendar();
    // calendar.init({
    //     'trigger': '#demo1',
    //     'type': 'date'
    // });
        var weekdayArr=['2018-08','2018-09'];
        var timeArr = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30'];
        // var mobileSelect2 = new MobileSelect({
        //     trigger: '#trigger2',
        //     title: '体检时间',
        //     wheels: [
        //         {data: weekdayArr},
        //         {data: timeArr},
        //     ],
        //     position:[1, 2],
        //     transitionEnd:function(indexArr, data){
        //         // console.log(indexArr[0]);
        //         // Array.prototype.remove = function(val) {
        //         //     var index = this.indexOf(val);
        //         //     if (index > -1) {
        //         //         this.splice(index, 1);
        //         //     }
        //         // };
        //         // if(indexArr[0] == 0) {
        //         //     console.log(timeArr)
        //         //     timeArr=timeArr.push(31')
        //         // }else {
        //         //     timeArr.remove('31')
        //         // }
        //     },
        //     callback:function(indexArr, data){
        //         console.log(data);
        //     }
        // });
        var mobileSelect4 = new MobileSelect({
            trigger: '#trigger4',
            title: '体检时间选择',
            wheels: [
                {data:[
                        {
                            id:'1',
                            value:'2018-08',
                            childs:[
                                {id:'1',value:'1'},
                                {id:'2',value:'2'},
                                {id:'3',value:'3'},
                                {id:'4',value:'4'},
                                {id:'5',value:'5'},
                                {id:'6',value:'6'},
                                {id:'7',value:'7'},
                                {id:'8',value:'8'},
                                {id:'9',value:'9'},
                                {id:'10',value:'10'},
                                {id:'11',value:'11'},
                                {id:'12',value:'12'},
                                {id:'13',value:'13'},
                                {id:'14',value:'14'},
                                {id:'15',value:'15'},
                                {id:'16',value:'16'},
                                {id:'17',value:'17'},
                                {id:'18',value:'18'},
                                {id:'19',value:'19'},
                                {id:'20',value:'20'},
                                {id:'21',value:'21'},
                                {id:'22',value:'22'},
                                {id:'23',value:'23'},
                                {id:'24',value:'24'},
                                {id:'25',value:'25'},
                                {id:'26',value:'26'},
                                {id:'27',value:'27'},
                                {id:'28',value:'28'},
                                {id:'29',value:'29'},
                                {id:'30',value:'30'},
                                {id:'31',value:'31'},
                            ]
                        },
                        {
                            id:'2',
                            value:'2018-09',
                            childs:[
                                {id:'1',value:'1'},
                                {id:'2',value:'2'},
                                {id:'3',value:'3'},
                                {id:'4',value:'4'},
                                {id:'5',value:'5'},
                                {id:'6',value:'6'},
                                {id:'7',value:'7'},
                                {id:'8',value:'8'},
                                {id:'9',value:'9'},
                                {id:'10',value:'10'},
                                {id:'11',value:'11'},
                                {id:'12',value:'12'},
                                {id:'13',value:'13'},
                                {id:'14',value:'14'},
                                {id:'15',value:'15'},
                                {id:'16',value:'16'},
                                {id:'17',value:'17'},
                                {id:'18',value:'18'},
                                {id:'19',value:'19'},
                                {id:'20',value:'20'},
                                {id:'21',value:'21'},
                                {id:'22',value:'22'},
                                {id:'23',value:'23'},
                                {id:'24',value:'24'},
                                {id:'25',value:'25'},
                                {id:'26',value:'26'},
                                {id:'27',value:'27'},
                                {id:'28',value:'28'},
                                {id:'29',value:'29'},
                                {id:'30',value:'30'},
                            ]
                        },
                    ]}
            ],
            transitionEnd:function(indexArr, data){
                // console.log(data);
            },
            callback:function(indexArr, data){
            }
        });
</script>
</html>